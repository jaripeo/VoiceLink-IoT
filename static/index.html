<!doctype html>
<html>

<head>
    <meta charset="utf-8" />
    <title>Audio Receiver & Visualizer</title>
    <script src="https://unpkg.com/wavesurfer.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 16px;
        }

        .panel {
            margin-bottom: 20px;
        }
    </style>
</head>

<body>
    <h2>Audio Receiver & Visualizer</h2>

    <div class="panel">
        <h3>Original (received)</h3>
        <div id="waveform-orig"></div>
        <div>
            <button id="playOrig" disabled>Play/Pause</button>
            <button id="reloadOrig">Reload Original</button>
            <button id="recordRemote">Record on Pi</button>
        </div>
    </div>

    <div class="panel">
        <h3>Pitched (live)</h3>
        <div>
            Pitch factor: <input id="factor" type="range" min="0.5" max="2.0" step="0.01" value="1.0"> <span
                id="fval">1.00</span>
            <button id="apply">Apply</button>
        </div>
        <div>
            <button id="playPit" disabled>Play/Pause</button>
        </div>
        <div id="waveform-pitched"></div>
    </div>

    <div class="panel">
        <h3>Spectrogram (Plotly)</h3>
        <div>
            <button id="specOrig">Original</button>
            <button id="specPitched">Pitched</button>
        </div>
        <div id="spectrogram" style="width:900px;height:400px;"></div>
    </div>

    <div class="panel">
        <h3>Waveform Comparison</h3>
        <div>
            <button id="reloadWaveforms">Reload Waveforms</button>
        </div>
        <div>
            <img id="waveforms_img" src="/visuals/waveforms.png?rand=0" alt="Waveforms"
                style="max-width:100%;height:auto;border:1px solid #ccc;" />
        </div>
    </div>

    <script>
        // Wavesurfer instances
        const wsOrig = WaveSurfer.create({ container: '#waveform-orig', waveColor: '#7fbfff', progressColor: '#0077cc', height: 120 });
        const wsPit = WaveSurfer.create({ container: '#waveform-pitched', waveColor: '#ffb37f', progressColor: '#ff6600', height: 120 });

        function loadOriginal() {
            document.getElementById('playOrig').disabled = true;
            wsOrig.load('/audio/original');
        }

        document.getElementById('reloadOrig').addEventListener('click', loadOriginal);

        document.getElementById('recordRemote').addEventListener('click', async function () {
            const btn = this;
            btn.disabled = true;
            btn.textContent = 'Requesting...';
            try {
                const res = await fetch('/control/record', { method: 'POST' });
                if (!res.ok) {
                    alert('Failed to request remote recording');
                } else {
                    alert('Recording requested on Pi â€” wait a few seconds then click Reload Original');
                }
            } catch (e) {
                alert('Error contacting server');
            }
            btn.disabled = false;
            btn.textContent = 'Record on Pi';
        });

        // enable play button when original is ready
        wsOrig.on('ready', function () {
            document.getElementById('playOrig').disabled = false;
        });

        document.getElementById('playOrig').addEventListener('click', function () {
            wsOrig.playPause();
        });

        // pitch controls
        const factorInput = document.getElementById('factor');
        const fval = document.getElementById('fval');
        factorInput.addEventListener('input', () => { fval.textContent = parseFloat(factorInput.value).toFixed(2); });

        async function applyPitch() {
            const f = factorInput.value;
            const url = '/audio/pitched?factor=' + encodeURIComponent(f);
            // fetch blob and load into wavesurfer pitched
            document.getElementById('playPit').disabled = true;
            const res = await fetch(url);
            if (!res.ok) { alert('No audio received yet'); return; }
            const blob = await res.blob();
            const objectUrl = URL.createObjectURL(blob);
            wsPit.load(objectUrl);
            // update spectrogram for pitched automatically if visible
            drawSpectrogram('pitched', f);
        }

        // enable play button when pitched audio is ready
        wsPit.on('ready', function () {
            document.getElementById('playPit').disabled = false;
        });

        document.getElementById('playPit').addEventListener('click', function () {
            wsPit.playPause();
        });

        document.getElementById('apply').addEventListener('click', applyPitch);

        // spectrogram plotting
        async function fetchSpectrogram(which, factor = 1.0) {
            let url = '/api/spectrogram?which=' + which + '&nperseg=1024&max_freq=400&max_time=400';
            if (which === 'pitched') url += '&factor=' + encodeURIComponent(factor);
            const res = await fetch(url);
            if (!res.ok) { alert('No audio yet'); return null; }
            return res.json();
        }

        async function drawSpectrogram(which, factor = 1.0) {
            const data = await fetchSpectrogram(which, factor);
            if (!data) return;
            const S = data.S; // 2D array freq x time
            const f = data.f;
            const t = data.t;

            const trace = {
                z: S,
                x: t,
                y: f,
                type: 'heatmap',
                colorscale: 'Viridis'
            };
            const layout = { title: 'Spectrogram - ' + which, xaxis: { title: 'Time (s)' }, yaxis: { title: 'Frequency (Hz)' } };
            Plotly.newPlot('spectrogram', [trace], layout, { responsive: true });
        }

        document.getElementById('specOrig').addEventListener('click', () => drawSpectrogram('original'));
        document.getElementById('specPitched').addEventListener('click', () => drawSpectrogram('pitched', factorInput.value));

        // initial load
        loadOriginal();

        // Waveform image updater
        async function updateWaveforms(factor = 1.0, duration = 0.1) {
            const img = document.getElementById('waveforms_img');
            // cache bust
            img.src = '/visuals/waveforms.png?factor=' + encodeURIComponent(factor) + '&duration=' + encodeURIComponent(duration) + '&rand=' + Date.now();
        }

        document.getElementById('reloadWaveforms').addEventListener('click', () => updateWaveforms(factorInput.value));

        // Refresh waveform when original loads or pitched is applied
        wsOrig.on('ready', function () { updateWaveforms(1.0); });
        wsPit.on('ready', function () { updateWaveforms(factorInput.value); });
    </script>
</body>

</html>